---
layout: post
title:  "Keycloak (or something)"
---

{% raw %}

[Keycloak] makes Single Sign-On through OpenID Connect (OIDC) easy!
In Keycloak you create a client, then grab the client ID, client secret, and Keycloak's OIDC URL.
In the application you're configuring for single sign-on, paste that information in. Usually that's all you need.

Authorization on the other hand is tricky.

If your application supports authorization based on claims returned from the OIDC client, great!
Some applications have a secondary process for authorization, for example syncing groups in the app from an external source, like LDAP.
Other applications do have RBAC support but still let users who authenticate through Keycloak into the application.

OpenShift, for example, will create an account for any user that Keycloak authenticates.
You can set new users to have 0 permissions in OpenShift but if Keycloak authenticates the user, that user will be created in OpenShift.

In order to prevent users from being created in an application, I use a custom authentication flow in Keycloak.
The flow denies users in Keycloak, before they are even redirected to the application.
If the user isn't allowed to acces the application, Keycloak stops the process and doesn't redirect back to the application.
Instead it shows an error indicating that the user is not authorized to access the application.

Unfortionately, most of Keycloak is configured through the web UI.
This makes information sharing more difficult.

I've included step-by-step instructions below.

These instructions use OpenShift as the application.
It's assumed that a client has been configured in Keycloak and that OpenShift has been configured to use that client for authentication.

## Create the Role, Group, and Role Binding

The first step is to create a role, create a group, and bind those together.
It's a good idea to keep these the same name.

I used `ocp-user` for my group and role name.

### Add a New Role

* On the left side navigation bar, select *Roles*
* Add a new role

![Add a new role](assets/2022-10-31-Keycloak/01_add_role.png)

### Create a New Group

* On the left side navigation bar, select *Groups*.
* Create a new group

![Create a new group](assets/2022-10-31-Keycloak/02_create_group.png)

### Bind the Group to the Role

* On the group page, select the *Role Bindings* tab
* Bind the `ocp-user` group to the `ocp-user` role

![Bind group to role](assets/2022-10-31-Keycloak/03_group_role_mappings.png)

## Create Users

The next step is to create users that will access OpenShift.
For this example, I created two users:

* `ryan` - Is an OpenShift user
* `logan` - Is **not** an OpenShift user

These two users will be tested to validate that Keycloak is denying users that aren't in the `ocp-users` group.

### Create an OpenShift User

* On the left side navigation bar, select *Users*
* Create a new user
* **Note the `ocp-user` group membership on this user**

![Create an OpenShift user](assets/2022-10-31-Keycloak/04_add_ocp_user.png)

### Create a Regular (Non-OpenShift) User

* On the left side navigation bar, select *Users*
* Create a new user
* **Do not add the `ocp-user` group membership on this user**

![Create an non-OpenShift user](assets/2022-10-31-Keycloak/05_add_non_ocp_user.png)

## Create an Authentication Flow

The next step is to create an authentication flow that will be executed when a user is redirected to Keycloak for authentication.
Keycloak comes with several authentication flows out of the box, but I find it easier to start from scratch instead of copying an existing flow.
Once you create an initial flow, it's ok to copy that flow for other applications.
(For example if you need to deny access to OpenShift and Vault based on two separate groups.)

### Create the OpenShift Authentication Flow

* On the left side navigation bar, select *Authentication*
* On the right, select *New*
* Name the authentication *OpenShift*

![Create a top-level authentication form](assets/2022-10-31-Keycloak/06_create_top_level_authentication_form.png)

### Add Execution Steps into the OpenShift Authentication Flow

* On the right, select *Add Sub-flow*
* Create a sub-flow named *Login*
* Create a second sub-flow named *RBAC*
* **Make sure the sub-flows are not nested. They should both be at the root level.**
* Reference the screenshot below to create *execution steps*

![Authentication flow overview](assets/2022-10-31-Keycloak/07_authentication_executions.png)

### Configure Execution Steps

* Only two configurations steps need to be configured
* Under *Actions*, configure the *Condition - User Role* execution step
* Set the role to `ocp-user`

![Configure "Condition - User Role" execution step](assets/2022-10-31-Keycloak/08_condition_user_role_config.png)

* Under *Actions*, configure the *Deny Access* execution step
* Set the deny message to `Access Denied: User does not the the "ocp-user" role`

![Configure "Deny Access" execution step ](assets/2022-10-31-Keycloak/09_deny_user_config.png)

## Configure the Client

The last step is to configure the OpenShift client in Keycloak to use the OpenShift authentication flow created in the previous step.
Each realm in Keycloak has a default authentication flow for browsers that is used unless a client specifies an override.
Within each client, an override can be configured to use any other authentication flow.

### Set the OpenShift Client to use the OpenShift Authentication Flow

* On the left side navigation bar, select *Clients*
* Select the client configured for OpenShift
* On the *Config* tab, under *Authentication Flow Overrides*, set the *Browser Flow* to OpenShift.

![Set an authentication flow override for the OpenShift client](assets/2022-10-31-Keycloak/10_client_authentication_flow_override.png)

## Testing It

With everything configured, open a private browser window and navigate to the OpenShift console.
Select the Keycloak provider.
Enter the login information for the OCP user.
They should be redirected to OpenShift and successfully log in.

Open a second private browser window and navigate to the OpenShift console.
Select the Keycloak provider again.
Enter the login information for the non-OCP user.
They will receive the `Access Denied` message and will not be redirected to OpenShift or logged into OpenShift.

---

**Discuss this post on GitHub
[here](https://github.com/RyanMillerC/taco.moe/discussions/6)**! Comments and
feedback welcome.

---

{% endraw %}

[Keycloak]: https://www.keycloak.org/
